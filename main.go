package main

import (
	"log"
	"net/http"
	"os"

	"github.com/go-chi/chi/v5"
	"github.com/naluneotlichno/FP-GO-API/api"
	"github.com/naluneotlichno/FP-GO-API/database"
)

func main() {
	log.Println("‚úÖ üî• –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞!")

	// ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	if err := database.InitDB(database.GetDBPath()); err != nil {
		log.Fatalf("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: %v", err)
	}

	// ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞
	r := chi.NewRouter()

	// ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
	registerHandlers()

	// ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ /web
	webDir := "./web"
	fileServer := http.FileServer(http.Dir(webDir))
	r.Mount("/", fileServer)

	// ‚úÖ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
	startServer()
}

// üî• registerHandlers —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
func registerHandlers(r *chi.Mux) {
	// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ (POST)
	r.HandleFunc("/api/task", api.AddTaskHandler) // –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ (–ø–æ –ø—Ä–∏–º–µ—Ä—É —Ç–≤–æ–µ–≥–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)

	// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á (GET)
	r.HandleFunc("/api/task", api.GetTaskHandler) // –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ ID (GET –∑–∞–ø—Ä–æ—Å)

	// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ (PUT)
	r.HandleFunc("/api/task", api.UpdateTaskHandler) // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (PUT –∑–∞–ø—Ä–æ—Å)

	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã)
	r.HandleFunc("/api/nextdate", api.HandleNextDate)

	// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á (GET)
	r.HandleFunc("/api/tasks", api.GetTasksHandler)

}

// üî• startServer –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
func startServer() {
	port := os.Getenv("TODO_PORT")
	if port == "" {
		port = "7540"
	}

	log.Printf("‚úÖ üöÄ –°–µ—Ä–≤–µ—Ä –≤—ã–µ–∑–∂–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç %s. –ü–æ–¥—Ä—É–±–∞–µ–º—Å—è!", port)
	if err := http.ListenAndServe(":"+port, nil); err != nil {
		log.Fatalf("‚ùå –û–π-–æ–π, —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª: %v", err)
	}
}
